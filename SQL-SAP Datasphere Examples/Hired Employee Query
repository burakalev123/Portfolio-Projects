SELECT "userId",
    "startDate",
    "position",
    "terminationDate",
    "date"

FROM (
        SELECT "userId",
        "startDate",
        "position",
        "terminationDate",
        "date",
        DENSE_RANK() OVER (PARTITION BY "position", "date" ORDER BY "startDate" ASC) AS rwn
    FROM (
                SELECT DISTINCT hiredTab."userId",
            hiredTab."startDate",
            hiredPosTab."position",
            IFNULL(hiredTab."terminationDate", '99991231') AS terminationDate,
            DIM_MONTH."date"
        FROM "DOE_ANA_EMPLOYMENT" AS hiredTab
            INNER JOIN (
                        SELECT anaTab."userId",
                anaTab."position",
                signDateTab."signDate_eom"
            FROM "DOE_ANA_HR_EC_V2" AS anaTab
                LEFT JOIN (
                                SELECT "code",
                    "signDate",
                    "signDate_eom",
                    "vacant"
                FROM (
                                        SELECT "code",
                        "effectiveStartDate" AS signDate,
                        LAST_DAY(to_date("effectiveStartDate")) AS signDate_eom,
                        "vacant",
                        LAG("vacant") OVER (PARTITION BY "code" ORDER BY "effectiveStartDate") AS pre_vac
                    FROM "SFD_R_Position_SFC"
                                    )
                WHERE "vacant" = 'false'
                    AND "pre_vac" = 'true'
                            ) AS signDateTab ON anaTab."position" = signDateTab."code"
            WHERE anaTab."position" IS NOT NULL
                AND anaTab."userId" IS NOT NULL
            GROUP BY anaTab."userId",
                            anaTab."position",
                            signDateTab."signDate_eom"
                    ) AS hiredPosTab ON hiredTab."userId" = hiredPosTab."userId"
            FULL JOIN "DOE_C_DIMENSION_MONTH" AS DIM_MONTH ON DIM_MONTH."date" <= hiredTab."startDate" OR DIM_MONTH."date" >= hiredTab."startDate"
        WHERE DIM_MONTH."date" < IFNULL(hiredTab."terminationDate", '99991231')
            AND DIM_MONTH."date" > hiredPosTab."signDate_eom"
            AND DIM_MONTH."date" < hiredTab."startDate"
            ) AS t1
    ) AS t2
WHERE rwn = 1


